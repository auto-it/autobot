import { PullRequestPlugin, PullRequestAction } from "../plugin";
import { Hooks, PRContext } from "../autobot";
import { getLogger } from "../utils/logger";
import { LabelRelease, LabelError } from "./calculate-release-by-labels";
import { Config } from "../config";
import dedent from "dedent";
import { createChecklist } from "../models/checklist";
import { renderLabel, populateLabel, getSkipReleaseLabelsFromConfig } from "../models/label";
import { sub, italics, bold } from "../utils/markdown";
import { slug } from "../utils/slug";

const logger = getLogger("pr-onboarding");

const createAutoChecklist = createChecklist.bind(null, "auto");

const MessageStart = "<!--- AutoPR:START --->";
const MessageEnd = "<!--- AutoPR:END --->";

const onBoardingMessage = (sections: string[]) => dedent`
    <!-- DO NOT EDIT -->
    ${MessageStart} 
    ---

    <img align="left" width="60" src="https://autobot.auto-it.now.sh/public/logo.png"/>

    ### Choose a release label

    This repository uses [auto](https://github.com/intuit/auto) to generate releases. In order to do that, 
    it needs an appropriate label assigned to each PR. Choose a label below that you feel best suites your changes.

    ${sections.join("\n\n")}
    
    <sub>_Generated by [auto-it](https://github.com/apps/auto-it)_</sub>
    ${MessageEnd} 
  `;

const sectionHeader = (text: string, secondaryText?: string, info?: string) =>
  sub(italics(`${bold(text)}${secondaryText ? ` ${secondaryText}` : ""}`));

const section = (header: string, checklist: string) => dedent`
    ##

    ${header}
    
    ${checklist}
    `;

const createLabelChecklists = async (context: PRContext, config: Config) => {
  // Fetch labels from config
  const { owner, repo } = context.repo();
  const { data: labels } = await context.github.issues.listLabelsForRepo({ owner, repo });
  // See which labels are in the repo, create the ones that don't exist

  const semverHead = sectionHeader("Semver Labels", "(choose one at most)");
  const semverChecklist = createAutoChecklist(
    "semver",
    await Promise.all(
      ["major", "minor", "patch"].map(async labelType => {
        const label = await populateLabel(labelType, config.labels[labelType], context, labels);

        return {
          id: labelType,
          checked: false,
          body: renderLabel(label),
        };
      }),
    ),
  );

  const skipReleaseHead = sectionHeader("Skip Release Labels");
  const skipReleaseChecklist = createAutoChecklist(
    "skiprelease",
    await Promise.all(
      getSkipReleaseLabelsFromConfig(config).map(async labelConfig => {
        const label = await populateLabel("skip-release", labelConfig, context, labels);

        return {
          id: label.name,
          checked: false,
          body: renderLabel(label),
        };
      }),
    ),
  );

  return [section(semverHead, semverChecklist), section(skipReleaseHead, skipReleaseChecklist)];
};

export class PROnBoarding extends PullRequestPlugin {
  private hasLabels: boolean = false;
  public name = "PROnBoarding";
  public actions = [
    PullRequestAction.opened,
    PullRequestAction.edited,
    PullRequestAction.labeled,
    PullRequestAction.unlabeled,
  ];

  public apply(prHooks: Hooks["pr"]) {
    logger.debug(`Applying hooks for ${this.name}`);
    prHooks.onReleaseType.tap(this.name, this.checkLabels);
    prHooks.process.tapPromise(this.name, this.onBoard);
  }

  private checkLabels = (release: LabelRelease) => {
    if (release.kind === "invalid" && release.reason === LabelError.NoLabels) {
      this.hasLabels = false;
    } else {
      this.hasLabels = true;
    }
  };

  private onBoard = async (context: PRContext, config: Config) => {
    // TODO: Check if feature is enabled
    if (context.payload.action === PullRequestAction.opened && this.hasLabels === false) {
      const { owner, repo, number: issue_number } = context.issue();
      // Initial on-boarding
      context.github.issues.update({
        owner,
        repo,
        issue_number,
        body:
          context.payload.pull_request.body + "\n\n" + onBoardingMessage(await createLabelChecklists(context, config)),
      });
    }
  };
}
